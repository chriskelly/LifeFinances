{% extends "base.html" %}

{% block title %}Results - LifeFinances{% endblock %}

{% block content %}
<div class="col-12">
    <div class="p-4 fade-in">
        <!-- Page Header -->
        <div class="mb-4">
            <h1>Simulation Results</h1>
            <p class="text-muted">Analysis of your retirement planning scenarios</p>
        </div>

        {% if success_percentage is not none %}
        <!-- Success Rate Row -->
        <div class="row g-4 mb-4">
            <!-- Success Rate Gauge -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-trophy"></i> Success Rate
                    </div>
                    <div class="card-body">
                        <div id="successGauge"></div>
                        <div class="text-center mt-3">
                            <h2 class="{% if success_percentage >= 80 %}text-success{% elif success_percentage >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                {{ success_percentage }}%
                            </h2>
                            <p class="lead mb-2">
                                {% if success_percentage >= 80 %}
                                    <span class="badge bg-success">Excellent</span>
                                {% elif success_percentage >= 60 %}
                                    <span class="badge bg-warning">Moderate</span>
                                {% else %}
                                    <span class="badge bg-danger">Low</span>
                                {% endif %}
                            </p>
                            <p class="text-muted small">
                                Based on 500 Monte Carlo trials
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Key Metrics
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <div class="text-muted small">Successful Trials</div>
                                    <h3 class="mb-0 text-success">{{ (success_percentage * 5)|int }}</h3>
                                    <small class="text-muted">out of 500</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-danger bg-opacity-10 rounded">
                                    <div class="text-muted small">Failed Trials</div>
                                    <h3 class="mb-0 text-danger">{{ (500 - success_percentage * 5)|int }}</h3>
                                    <small class="text-muted">out of 500</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-3 bg-primary bg-opacity-10 rounded">
                                    <div class="text-muted small mb-2">Interpretation</div>
                                    <p class="mb-0 small">
                                        {% if success_percentage >= 80 %}
                                            Your financial plan has a <strong>high probability</strong> of meeting your retirement goals. Continue monitoring and adjusting as needed.
                                        {% elif success_percentage >= 60 %}
                                            Your plan has a <strong>moderate probability</strong> of success. Consider adjusting spending, savings, or retirement age for better outcomes.
                                        {% else %}
                                            Your plan has a <strong>low probability</strong> of success. Significant adjustments to spending, savings, or retirement timing are recommended.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Variable Chart -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up-arrow"></i> Variable Projection (First Trial)</span>
                <div class="d-flex gap-2 align-items-center">
                    <label for="variableSelect" class="mb-0 small text-muted">Select Variable:</label>
                    <select id="variableSelect" class="form-select form-select-sm" style="width: 250px;">
                        <optgroup label="Wealth">
                            {% for col in chartable_columns %}
                            {% if col.category == "Wealth" %}
                            <option value="{{ col.name }}" {% if col.name == "Net Worth" %}selected{% endif %}>{{ col.display_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Income">
                            {% for col in chartable_columns %}
                            {% if col.category == "Income" %}
                            <option value="{{ col.name }}">{{ col.display_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Expenses">
                            {% for col in chartable_columns %}
                            {% if col.category == "Expenses" %}
                            <option value="{{ col.name }}">{{ col.display_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Taxes">
                            {% for col in chartable_columns %}
                            {% if col.category == "Taxes" %}
                            <option value="{{ col.name }}">{{ col.display_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Asset Allocation">
                            {% for col in chartable_columns %}
                            {% if col.category == "Allocation" %}
                            <option value="{{ col.name }}">{{ col.display_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Rates">
                            {% for col in chartable_columns %}
                            {% if col.category == "Rates" %}
                            <option value="{{ col.name }}">{{ col.display_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Other">
                            {% for col in chartable_columns %}
                            {% if col.category == "Other" %}
                            <option value="{{ col.name }}">{{ col.display_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" id="btnMaximizeChart" title="Maximize chart">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="dynamicChart"></div>
            </div>
        </div>

        <!-- Fullscreen Chart Modal -->
        <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chartModalLabel">
                            <i class="bi bi-graph-up-arrow"></i> <span id="modalChartTitle">Net Worth</span> Projection
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="fullscreenChart" style="height: calc(100vh - 150px);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> Detailed Results (First Trial)</span>
                <button class="btn btn-sm btn-outline-primary" id="btnExportCSV">
                    <i class="bi bi-download"></i> Export CSV
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    {{ first_results_table | safe }}
                </div>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2">
            <a href="{{ url_for('run') }}" class="btn btn-primary">
                <i class="bi bi-arrow-repeat"></i> Run Again
            </a>
            <a href="{{ url_for('config') }}" class="btn btn-outline-primary">
                <i class="bi bi-gear"></i> Modify Configuration
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house"></i> Back to Dashboard
            </a>
        </div>

        {% else %}
        <!-- No Results Card -->
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h3 class="mt-3">No Results Available</h3>
                <p class="text-muted mb-4">Run a simulation to see results here</p>
                <a href="{{ url_for('run') }}" class="btn btn-primary">
                    <i class="bi bi-play-circle"></i> Run Simulation
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if success_percentage is not none and gauge_chart_json %}
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
// Store results data for dynamic charting
const resultsData = {{ results_data_json | safe }};

// Render Plotly charts
document.addEventListener('DOMContentLoaded', function() {
    // Success Rate Gauge
    const gaugeData = {{ gauge_chart_json | safe }};
    Plotly.newPlot('successGauge', gaugeData.data, gaugeData.layout, {
        displayModeBar: false,
        responsive: true
    });

    // Store current variable for fullscreen chart
    let currentVariable = 'Net Worth';

    // Dynamic Variable Chart
    function updateDynamicChart(variableName, targetDiv = 'dynamicChart', customHeight = 300) {
        if (!resultsData || resultsData.length === 0) return;

        // Store current variable
        currentVariable = variableName;

        // Extract x and y data
        const xData = resultsData.map(row => row['Date']);
        const yData = resultsData.map(row => row[variableName]);

        // Determine if this is a percentage variable
        const isPercentage = variableName.includes('%');
        const isRate = variableName.toLowerCase().includes('rate');

        // Format for hover and axis
        let yFormat = '$,.0f';
        let ySuffix = 'K';
        let hoverTemplate = `<b>%{x}</b><br>${variableName}: $%{y:,.0f}K<extra></extra>`;

        if (isPercentage) {
            yFormat = '.1%';
            ySuffix = '';
            hoverTemplate = `<b>%{x}</b><br>${variableName}: %{y:.1%}<extra></extra>`;
        } else if (isRate) {
            yFormat = '.2%';
            ySuffix = '';
            hoverTemplate = `<b>%{x}</b><br>${variableName}: %{y:.2%}<extra></extra>`;
        }

        const trace = {
            x: xData,
            y: yData,
            mode: 'lines',
            name: variableName,
            line: { color: '#3B82F6', width: 2 },
            fill: 'tozeroy',
            fillcolor: 'rgba(59, 130, 246, 0.1)',
            hovertemplate: hoverTemplate
        };

        const layout = {
            paper_bgcolor: '#1E293B',
            plot_bgcolor: '#1E293B',
            font: { color: '#F1F5F9' },
            height: customHeight,
            margin: { l: 60, r: 20, t: 20, b: 40 },
            xaxis: {
                gridcolor: '#334155',
                showgrid: true,
                tickangle: 45,
                tickfont: { color: '#94A3B8' }
            },
            yaxis: {
                gridcolor: '#334155',
                showgrid: true,
                tickfont: { color: '#94A3B8' },
                tickformat: yFormat,
                ticksuffix: ySuffix
            },
            hovermode: 'x unified',
            showlegend: false
        };

        Plotly.newPlot(targetDiv, [trace], layout, {
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            responsive: true
        });
    }

    // Initial chart render with Net Worth
    updateDynamicChart('Net Worth');

    // Variable selector change handler
    document.getElementById('variableSelect').addEventListener('change', function(e) {
        updateDynamicChart(e.target.value);
    });

    // Maximize chart button handler
    document.getElementById('btnMaximizeChart').addEventListener('click', function() {
        // Update modal title
        document.getElementById('modalChartTitle').textContent = currentVariable;

        // Show modal
        const chartModal = new bootstrap.Modal(document.getElementById('chartModal'));
        chartModal.show();

        // Wait for modal to be shown, then render fullscreen chart
        document.getElementById('chartModal').addEventListener('shown.bs.modal', function() {
            const fullscreenHeight = window.innerHeight - 150;
            updateDynamicChart(currentVariable, 'fullscreenChart', fullscreenHeight);
        }, { once: true });
    });

    // Re-render fullscreen chart on window resize
    window.addEventListener('resize', function() {
        const modal = document.getElementById('chartModal');
        if (modal.classList.contains('show')) {
            const fullscreenHeight = window.innerHeight - 150;
            updateDynamicChart(currentVariable, 'fullscreenChart', fullscreenHeight);
        }
    });
});

// CSV Export functionality
document.getElementById('btnExportCSV')?.addEventListener('click', function() {
    const table = document.querySelector('.table-responsive table');
    if (!table) return;

    let csv = [];
    const rows = table.querySelectorAll('tr');

    rows.forEach(row => {
        const cols = row.querySelectorAll('td, th');
        const csvRow = [];
        cols.forEach(col => {
            // Escape quotes and wrap in quotes if contains comma
            let text = col.textContent.trim();
            if (text.includes(',') || text.includes('"')) {
                text = '"' + text.replace(/"/g, '""') + '"';
            }
            csvRow.push(text);
        });
        csv.push(csvRow.join(','));
    });

    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', 'simulation_results.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
{% endif %}
{% endblock %}
