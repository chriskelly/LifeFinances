name: Main CI

on:
  push:
  pull_request:

jobs:
  docker_test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create user config
        run: cp tests/sample_configs/full_config.yml config.yml

      - name: Run Tests (with retry on Docker Hub errors)
        run: |
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            if make; then
              echo "Tests passed!"
              exit 0
            else
              echo "Attempt $i failed"
              if [ $i -lt 3 ]; then
                echo "Retrying in 30 seconds..."
                sleep 30
              fi
            fi
          done
          echo "All attempts failed"
          exit 1
